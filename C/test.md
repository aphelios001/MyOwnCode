### 契约: processBorrowRequest

| 项目          | 描述                                                                                                                                                              |
|---------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **名称** | `processBorrowRequest(readerId: String, copyId: String)`                                                                                                          |
| **职责** | 验证读者借阅资格和图书副本的可用性，记录借阅事件，并更新图书副本状态为"已借出"。                                                                                    |
| **类型** | 系统                                                                                                                                                              |
| **交叉引用** | 功能B1.1、B1.3、B2.2, 借阅管理模块, 读者信息模块, 图书库存模块                                                                                          |
| **用况** | 借阅图书                                                                                                                                                          |
| **注释** | 确保读者资格验证和图书状态更新的原子性。                                                                                                                          |
| **异常** | - 若 copyId 无效或对应图书副本状态非"可借阅"或已被借出，系统提示"库存不足"或相应错误。<br>- 若 readerId 无效或读者存在逾期未还记录或当前借阅数量已达上限，系统提示"无法借阅"。 |
| **输出** | 显示借阅成功信息，生成借阅记录详情。                                                                                                                                |
| **前置条件** | - 系统中存在具有所提供 readerId 的读者记录。<br>- 系统中存在具有所提供 copyId 的图书副本记录。<br>- ID为 copyId 的图书副本当前状态为"可借阅"。 <br>- ID为 readerId 的读者借阅资格有效（无逾期未还、未达借阅上限）。 |
| **后置条件** | ■ 创建了一个新的借阅记录实例 (Loan)。<br>■ 新的借阅记录实例关联了读者 (readerId) 和图书副本 (copyId)。<br>■ 新的借阅记录实例包含了借出日期（当前系统日期）和计算得出的应还日期。<br>■ ID为 copyId 的图书副本实例的状态被更新为"已借出"。 <br>■ (可选) ID为 readerId 的读者的当前借阅数量属性被更新（加1）。 |

---

### 契约: returnBook

| 项目          | 描述                                                                                                                                                                                                                                |
|---------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **名称** | `returnBook(copyId: String)`                                                                                                                                                                                                      |
| **职责** | 处理图书归还请求，验证图书的借阅状态，计算可能的逾期罚款，更新图书副本状态，并结束或归档相应的借阅记录。                                                                                                                                |
| **类型** | 系统                                                                                                                                                                                                                                |
| **交叉引用** | 借阅管理模块, 罚款管理模块, 赔偿流程模块, 图书库存模块                                                                                                                                                                            |
| **用况** | 归还图书                                                                                                                                                                                                                            |
| **注释** | 罚款计算规则和图书损坏处理可能需要根据具体业务规则配置。管理员可调整或豁免罚款。                                                                                                                                                      |
| **异常** | - 若 copyId 无效或该图书副本未处于"已借出"状态，系统提示“无效归还请求”。<br>- 若借阅该书的读者账户已被冻结，系统提示“账户受限”。                                                                                                                  |
| **输出** | 显示归还成功信息；若有罚款，显示罚款金额；若图书被标记为损坏，提示后续处理流程；（可选）打印归还收据。                                                                                                                                      |
| **前置条件** | - 系统中存在具有所提供 copyId 的图书副本记录。<br>- ID为 copyId 的图书副本当前状态为"已借出"。 <br>- 系统中存在一个与 copyId 关联的活动借阅记录。                                                                                             |
| **后置条件** | ■ 找到与 copyId 关联的活动借阅记录实例。<br>■ (若图书逾期) 根据逾期天数和规则计算罚款金额，并创建或更新与该读者关联的罚款记录。<br>■ (若管理员标记图书损坏) ID为 copyId 的图书副本实例的状态被更新为"损坏"或类似状态，并可能触发赔偿流程，记录相关信息。<br>■ (若图书未逾期且未损坏) ID为 copyId 的图书副本实例的状态被更新为"可借阅"。 <br>■ 原活动借阅记录实例的状态被更新为"已归还"或被归档/逻辑删除。<br>■ (可选) 借阅该书的读者的当前借阅数量属性被更新（减1）。 |

---

### 契约: searchBooks

| 项目          | 描述                                                                                                                            |
|---------------|-------------------------------------------------------------------------------------------------------------------------------|
| **名称** | `searchBooks(query: String)`                                                                                                    |
| **职责** | 根据用户输入的查询条件（如书名、作者、ISBN），在图书信息库中检索匹配的图书，并返回包含基本信息和当前状态的结果列表。                      |
| **类型** | 系统                                                                                                                            |
| **交叉引用** | 图书信息管理模块, 借阅状态模块, 用户权限模块 (间接影响显示内容)                                                                   |
| **用况** | 查询图书                                                                                                                        |
| **注释** | 查询应能处理基础的关键词匹配，并考虑过滤潜在的恶意输入（如SQL注入）。                                                            |
| **异常** | - 若 query 包含系统定义的非法字符，系统提示“输入不合法”。                                                                         |
| **输出** | 返回一个图书信息列表，每项包含书名、作者、状态（可借/已借出）、馆藏位置等；若无匹配项，显示“未找到相关书籍，建议调整关键词”。            |
| **前置条件** | - 图书信息数据库可访问。                                                                                                        |
| **后置条件** | ■ 系统状态未发生改变（此操作为只读查询）。<br>■ 返回一个包含零个或多个图书摘要信息的列表给调用者。                                       |

---

### 契约: viewDetails

| 项目          | 描述                                                                                                                                                            |
|---------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **名称** | `viewDetails(bookID: String)`                                                                                                                                 |
| **职责** | 接收一个图书ID，查询并展示该图书的详细信息，可能包括简介、出版社、ISBN、分类、当前所有副本的状态、馆藏位置、借阅历史（可能受权限限制）等。                        |
| **类型** | 系统                                                                                                                                                            |
| **交叉引用** | 图书信息管理模块, 借阅管理模块, 借阅状态模块, 用户权限模块                                                                                                        |
| **用况** | 查询图书                                                                                                                                                        |
| **注释** | 访客用户可能无法查看某些详细信息，如完整的借阅历史。                                                                                                              |
| **异常** | - 若 bookID 在系统中不存在，系统提示“图书信息不存在”或类似错误。<br>- 若当前用户（如访客）试图访问受限信息（如借阅历史），系统提示“仅注册读者可查看，请登录”。             |
| **输出** | 显示指定 bookID 对应图书的详细信息。                                                                                                                              |
| **前置条件** | - 系统中存在具有所提供 bookID 的图书主记录。                                                                                                                      |
| **后置条件** | ■ 系统状态未发生改变（此操作为只读查询）。<br>■ 返回指定 bookID 的图书的完整详细信息（根据用户权限过滤）。                                                            |

---

### 契约: InputBookDetails

| 项目          | 描述                                                                                                                                                                                                                                |
|---------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **名称** | `InputBookDetails(bookDetails: List)`                                                                                                                                                                                             |
| **职责** | 接收包含新图书信息的列表（如书名、作者、ISBN、分类等），验证ISBN的唯一性。若唯一，则在系统中创建新的图书主记录和相应的图书副本记录，分配唯一标识符，生成条形码，并将其持久化存储。                                                              |
| **类型** | 系统                                                                                                                                                                                                                                |
| **交叉引用** | 图书信息管理模块, 系统生成条形码模块, 记录日志模块                                                                                                                                                                                |
| **用况** | 管理图书库存 (新增)                                                                                                                                                                                                                   |
| **注释** | `bookDetails` 列表的内容和顺序需要预先定义。系统自动生成的ID和条形码需保证唯一性。此操作对应管理员录入信息并确认保存的动作。                                                                                                                |
| **异常** | - 若 `bookDetails` 中提供的ISBN已存在于系统中，系统提示“该书已登记”。<br>- 若 `bookDetails` 缺少必要信息或格式不正确，系统提示相应的输入错误。                                                                                              |
| **输出** | 显示“操作成功”提示信息。                                                                                                                                                                                                              |
| **前置条件** | - 执行此操作的用户（图书管理员）具有相应的权限。<br>- 提供的 `bookDetails` 列表包含符合格式要求的必要图书信息，特别是有效的ISBN。                                                                                                        |
| **后置条件** | ■ 验证 `bookDetails` 中的ISBN是否已存在于图书主记录中。<br>■ (若ISBN唯一) 创建一个新的图书主记录 (BookSpecification) 实例，并使用 `bookDetails` 中的信息填充其属性。<br>■ (若ISBN唯一) 创建一个或多个关联到新图书主记录的图书副本 (BookCopy) 实例。<br>■ (若ISBN唯一) 为新的图书主记录和/或副本实例分配系统唯一的内部ID。<br>■ (若ISBN唯一) 为新的图书副本实例生成并关联唯一的条形码。<br>■ (若ISBN唯一) 新创建的图书副本实例的状态被设置为"可借阅"。 <br>■ (若ISBN唯一) 记录此新增操作的系统日志。 |

---

### 契约: requestRenewal

| 项目          | 描述                                                                                                                                                                                                                                                                                       |
|---------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **名称** | `requestRenewal(readerId: String, copyId: String)`                                                                                                                                                                                                                                         |
| **职责** | 处理读者或管理员为指定读者和图书副本发起的续借请求。系统需验证续借资格（如图书未被预约、读者账户正常、未达续借次数上限），若通过，则延长该借阅记录的应还日期。                                                                                                                                  |
| **类型** | 系统                                                                                                                                                                                                                                                                                       |
| **交叉引用** | 借阅管理模块, 预约管理模块, 系统通知模块, 读者管理模块                                                                                                                                                                                                                                       |
| **用况** | 续借图书                                                                                                                                                                                                                                                                                   |
| **注释** | 续借的具体时长（如30天）和最大续借次数是系统配置参数。                                                                                                                                                                                                                                       |
| **异常** | - 若 copyId 或 readerId 无效，或该 copyId 当前并非由该 readerId 借阅，系统提示错误。<br>- 若 ID为 copyId 的图书副本存在有效的预约记录，系统提示“无法续借：该书已被预约”。<br>- 若 ID为 readerId 的读者账户存在逾期未还图书或状态异常，系统提示“账户受限，请先归还逾期图书”或类似信息。<br>- 若该次借阅已达到系统设定的最大续借次数，系统提示“续借次数已用完”。 |
| **输出** | 若续借成功，显示成功信息及新的应还日期；若失败，显示具体的失败原因。                                                                                                                                                                                                                           |
| **前置条件** | - 系统中存在具有所提供 readerId 的读者记录。<br>- 系统中存在具有所提供 copyId 的图书副本记录。<br>- 存在一个活动的借阅记录，关联了 readerId 和 copyId。                                                                                                                                           |
| **后置条件** | ■ 查找与 readerId 和 copyId 关联的当前活动借阅记录实例。<br>■ 检查 ID为 copyId 的图书副本是否有未完成的预约请求。<br>■ 检查 ID为 readerId 的读者账户状态是否允许续借（无逾期、账户正常）。<br>■ 检查当前借阅记录的已续借次数是否小于系统允许的最大次数。<br>■ (若所有检查通过) 更新该借阅记录实例的应还日期属性（原应还日期 + 续借周期）。<br>■ (若所有检查通过) 更新该借阅记录实例的续借次数字段（加1）。<br>■ (若所有检查通过) 可能向读者发送续借成功的通知。                       |